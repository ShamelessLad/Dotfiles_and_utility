chrome.storage.local.get(function(a){chrome.storage.sync.get(function(b){function c(a,b){this.popup_container=document.querySelector("#"+a),this.callback=b,this.go()}function d(c){this.storageArea=function(){return"session"===c?chrome.storage.local:chrome.storage.sync}(),this.data_local_copy=function(){var d,e=function(){return"session"===c?a:b}(),f={};for(d in e)0===d.indexOf("tg_")&&(f[d]=e[d]);return f}()}function e(a){this.storage=function(){return"session"===a?chrome.storage.local:chrome.storage.sync}(),this.model="session"===a?h:f}c.prototype={go:function(){function d(){var c={};[].forEach.call(b,function(a){c[a.id]=a.value}),a.popup_container.style.display="none",a.callback(c)}var a=this,b=a.popup_container.querySelectorAll(".data"),c=this.popup_container.querySelector(".submit_btn");this.popup_container.style.display="block",b.length?(b[0].focus(),b[0].select(),"text"===b[b.length-1].getAttribute("type")&&(b[b.length-1].onkeyup=function(a){13===a.keyCode&&d()})):(c.focus(),this.popup_container.onkeyup=function(a){13===a.keyCode&&d()}),c.onclick=function(a){d()},this.popup_container.querySelector(".cancel").onclick=function(b){a.popup_container.style.display="none"}}},d.prototype={getGroups:function(){return this.data_local_copy},getStorageNameByName:function(a){var b;for(b in this.data_local_copy)if(this.data_local_copy[b].name===a)return b;return!1},nextIndex:function(){var b,a=0;for(b in this.data_local_copy)this.data_local_copy[b].index>a&&(a=this.data_local_copy[b].index);return a+1},del:function(a,b){var c=this;this.storageArea.remove(a,function(){chrome.runtime.lastError?b({err:1,msg:chrome.runtime.lastError.message}):(delete c.data_local_copy[a],b({err:0}))})},add:function(a,b,c){var d=new Date,e={},f="tg_"+d.getTime(),g=this;e[f]={name:void 0===a||0===a.length?"":a,index:this.nextIndex(),color:"",tabs:b},this.storageArea.set(e,function(){chrome.runtime.lastError?c({err:1,msg:chrome.runtime.lastError.message}):(g.data_local_copy[f]=e[f],c({err:0,storage_name:f,new_group:e[f]}))})},upd:function(a,b,c){var d={},e=this;d[a]=b,this.storageArea.set(d,function(){chrome.runtime.lastError?c({err:1,msg:chrome.runtime.lastError.message}):(e.data_local_copy[a]=b,c({err:0,storage_name:a,new_group:d[a]}))})},move:function(a,b,c){var d=this,e={},f={},g=this.data_local_copy[a].index;e[a]=this.data_local_copy[a],e[a].index=this.data_local_copy[b].index,f[b]=this.data_local_copy[b],f[b].index=g,this.storageArea.set(e,function(){chrome.runtime.lastError?c({err:1,msg:chrome.runtime.lastError.message}):d.storageArea.set(f,function(){chrome.runtime.lastError?c({err:1,msg:chrome.runtime.lastError.message}):(d.data_local_copy[a]=e[a],d.data_local_copy[b]=f[b],c({err:0}))})})}},e.prototype={getLocalLinkIndexById:function(a,b){var c,d=this.model.getGroups()[a].tabs,e=d.length;for(c=0;e>c;c++)if(d[c].id===parseInt(b,10))return c},groupLinksByWindowId:function(a){var b=this.model.getGroups()[a].tabs,c=[],d=[];return b.forEach(function(a){var b=c.indexOf(a.windowId);-1===b?(c.push(a.windowId),d.push([]),d[c.length-1].push(a)):d[b].push(a)}),{grouped_by_windowId:d,windowId_arr:c}},nextIndex:function(a){var b=this.model.getGroups()[a].tabs,c=0;return b.forEach(function(a){a.id>c&&(c=a.id)}),c+1},del:function(a,b,c){var d=this.model.getGroups()[a];d.tabs.splice(this.getLocalLinkIndexById(a,b),1),this.model.upd(a,d,function(a){c(a)})},add:function(a,b,c){var d=this.model.getGroups()[a];d.tabs.push(b),this.model.upd(a,d,function(a){c(a)})},upd:function(a,b,c,d){var e=this.model.getGroups()[a];e.tabs[b]=c,this.model.upd(a,e,function(a){d(a)})}};var r,f=new d("saved"),g=new e("saved"),h=new d("session"),i=new e("session"),j=48,k={title_del_group:chrome.i18n.getMessage("p_delGroup_btn_title"),title_edit_group_name:chrome.i18n.getMessage("p_editGroupName_btn_title"),title_add_link_to_group:chrome.i18n.getMessage("p_addLinkToGroup_btn_title"),title_group_in_new_window:chrome.i18n.getMessage("p_groupInNewWindow_btn_title"),title_edit_link:chrome.i18n.getMessage("p_editLink_btn_title"),title_del_link:chrome.i18n.getMessage("p_delLinkFromGroup_btn_title"),title_up_link:chrome.i18n.getMessage("p_upGroup_btn_title"),title_down_link:chrome.i18n.getMessage("p_downGroup_btn_title"),windows_numbers:chrome.i18n.getMessage("p_windowsNumbers_text"),tabs_numbers:chrome.i18n.getMessage("p_tabsNumbers_text"),window_text:chrome.i18n.getMessage("p_window_text"),quota_bytes_item:chrome.i18n.getMessage("p_quotaBites_error"),quota_default_item:chrome.i18n.getMessage("p_syncStorageDefault_error"),quota_bytes_per_item:chrome.i18n.getMessage("p_quotaBitesPerItem_error"),current_session:chrome.i18n.getMessage("p_currentSession")},l={tabsFilter:function(){var a={};return b.cur_win&&(a.currentWindow=!0),a},collectTabs:function(a){chrome.tabs.query(this.tabsFilter(),function(c){var d=[];c.forEach(function(a,c){var e={};a.pinned&&1!==b.pinned||(e.url=a.url,e.title=a.title.length>j?a.title.slice(0,j+1):a.title,e.id=c,a.pinned&&(e.pinned=a.pinned),d.push(e))}),a(d)})}},m=function(a){chrome.runtime.sendMessage({msg:"openLinksInNewWindow",links:a}),window.close()},n=function(a){chrome.runtime.sendMessage({msg:"openLinksInCurrentWindow",links:a})},o=function(a,b){chrome.runtime.sendMessage({msg:"openWindowLinksInCurrentWindow",links:a,window_id:b})},p={groupHtmlElement:function(a,c){var d=c.name;return""===c.name&&(d=utils.formatDate(new Date(parseInt(a.slice("tg_".length),10)),b.date_format)),'<div id="'+a+'" class="group"><span class="spoiler" name="closed"> &#9658;</span><span class="open_group">'+d+'</span><span class="open_in_new_window" title="'+k.title_group_in_new_window+'">&#10064;</span> <span class="group_action"><span class="add_link" title="'+k.title_add_link_to_group+'">&#10010;</span><span class="up" title="'+k.title_up_link+'">&#9650;</span><span class="down" title="'+k.title_down_link+'">&#9660;</span><span class="edit_group" title="'+k.title_edit_group_name+'">&#9776;</span><span class="del_group" title="'+k.title_del_group+'">&#10006;</span></span></div>'},linkHtmlElement:function(a,b){var c=b.title,d="",e=b.pinned?'<img class="pinned_icon" src="img/pin-26.png">':"",f="chrome"===localStorage.browser?"chrome://favicon/"+b.url:"opera://favicon/"+b.url;return b.title.length>=j&&(c=b.title.slice(0,j)+"...",d='title="'+b.title+'"'),'<div id="'+a+"_"+b.id+'" class="link"><span class="link_action"><span class="edit_link" title="'+k.title_edit_link+'">&#9776;</span><span class="del_link" title="'+k.title_del_link+'">&#10006;</span><a href="'+b.url+'" target="_blank" '+d+'><span class="favi" title="'+b.url+'"><img src="'+f+'"></span>'+e+c+"</a></span></div>"},openGroup:function(a,b){var c=f.getGroups()[a].tabs;1===b?m(c):n(c)},showGroups:function(){var a='<section id="error_msg"></section>',b=this,c=f.getGroups(),d=document.getElementById("saved"),e=Object.keys(c).sort(function(a,b){return c[b].index-c[a].index});e.forEach(function(d){a+=b.groupHtmlElement(d,c[d])}),d.innerHTML=a,this.showSyncStorageUsage()},addGroup:function(){var d,g,a=document.getElementById("new_group_name"),b=a.value,e=f.getStorageNameByName(b),h=this;l.collectTabs(function(i){e!==!1&&""!==b?d=new c("overwrite_group",function(b){a.value="",g=f.getGroups()[e],g.tabs=i,f.upd(e,g,function(a){0===a.err?h.showSyncStorageUsage():h.showErrorMsg(a.msg)})}):(a.value="",f.add(b,i,function(a){var b,c;0===a.err?(h.showSyncStorageUsage(),b=document.createElement("div"),c=document.getElementById("saved"),b.innerHTML=h.groupHtmlElement(a.storage_name,a.new_group),c.insertBefore(b,c.getElementsByTagName("div")[0]),c.innerHTML=c.innerHTML.replace(/(<div>)*|(<\/div>)*/g,"")):h.showErrorMsg(a.msg)}))})},editGroupName:function(a,b){var e,g,d=f.getGroups()[a],h=this;document.getElementById("popup-new_group_name").value=d.name,g=new c("edit_group_name",function(c){e=c["popup-new_group_name"],(void 0!==e||""!==e)&&(d.name=e,f.upd(a,d,function(a){0===a.err?(b.getElementsByClassName("open_group")[0].innerText=e,h.showSyncStorageUsage()):h.showErrorMsg(a.msg)}))})},delGroup:function(a,b){var c=this;f.del(a,function(a){0===a.err?(b.remove(),c.showSyncStorageUsage()):c.showErrorMsg(a.msg)})},moveGroup:function(a,b){var c=this;f.move(a,b,function(a){0===a.err?c.showGroups():c.showErrorMsg(a.msg)})},showGroupLinks:function(a,b){var c=document.createElement("div"),d=b.getElementsByClassName("spoiler")[0],e="",g=this;f.getGroups()[a].tabs.forEach(function(b){e+=g.linkHtmlElement(a,b)}),c.classList.add("links"),c.innerHTML=e,b.insertBefore(c,null),d.setAttribute("name","opened"),d.innerHTML=" &#9660;"},hideGroupLinks:function(a){var b=a.getElementsByClassName("spoiler")[0];b.setAttribute("name","closed"),b.innerHTML=" &#9658;",a.getElementsByClassName("links")[0].remove()},delLink:function(a,b,c){g.del(a,b,function(a){0===a.err&&c.remove()})},addLink:function(a,b){var d=this;new c("add_link",function(c){var e={id:g.nextIndex(a),title:c["popup-add_link_name"],url:utils.correctUrl(c["popup-add_link_link"])};g.add(a,e,function(c){if(0===c.err){var e=b.getElementsByClassName("links");e.length&&d.hideGroupLinks(b),d.showGroupLinks(a,b),d.showSyncStorageUsage()}else d.showErrorMsg(c.msg)})})},editLink:function(a,b,d){var j,e=d.parentNode.parentNode,h=f.getGroups()[a].tabs,i=g.getLocalLinkIndexById(a,b),k=this;document.getElementById("popup-edit_link_name").value=h[i].title,document.getElementById("popup-edit_link_url").value=h[i].url,j=new c("edit_link",function(b){var c=h[i];c.title=b["popup-edit_link_name"],c.url=utils.correctUrl(b["popup-edit_link_url"]),g.upd(a,i,c,function(b){0===b.err?(k.hideGroupLinks(e),k.showGroupLinks(a,e),k.showSyncStorageUsage()):k.showErrorMsg(b.msg)})})},showErrorMsg:function(a){var b=document.getElementById("error_msg"),c=k.quota_default_item;switch(b.style.display="block",a){case"QUOTA_BYTES_PER_ITEM quota exceeded":c=k.quota_bytes_per_item;break;case"QUOTA_BYTES quota exceeded":c=k.quota_bytes_item}b.innerText=c,setTimeout(function(){b.style.display="none"},4581)},showSyncStorageUsage:function(){chrome.storage.sync.getBytesInUse(null,function(a){var b=(100*a/chrome.storage.sync.QUOTA_BYTES).toFixed(2),c=document.querySelector("ul.tabs_nav>li a"),d=c.innerText;c.innerText=d.slice(0,d.indexOf("|"))+"| "+b+"%"})},setHandlers:function(){var a=this,b=document.getElementById("saved");document.getElementById("new_group").addEventListener("click",function(b){b.preventDefault(),a.addGroup()},!1),document.getElementById("new_group_name").addEventListener("keyup",function(b){13===b.keyCode&&a.addGroup()},!1),b.addEventListener("click",function(b){function i(a){return{storage_name:a.slice(0,a.lastIndexOf("_")),id:a.slice(a.lastIndexOf("_")+1)}}var d,e,f,g,h,c=b.target;switch(b.stopPropagation(),c.className){case"open_group":f=b.button,0===f&&b.ctrlKey===!0?a.openGroup(c.parentNode.id,1):a.openGroup(c.parentNode.id,b.button);break;case"open_in_new_window":a.openGroup(c.parentNode.id,1);break;case"up":d=c.parentNode.parentNode,g=d.previousSibling,g&&"group"===g.className&&a.moveGroup(d.id,g.id);break;case"down":d=c.parentNode.parentNode,g=d.nextSibling,g&&"group"===g.className&&a.moveGroup(d.id,g.id);break;case"del_group":d=c.parentNode.parentNode,a.delGroup(d.id,d);break;case"edit_group":d=c.parentNode.parentNode,a.editGroupName(d.id,d);break;case"add_link":d=c.parentNode.parentNode,a.addLink(d.id,d);break;case"spoiler":d=c.parentNode,"closed"===c.getAttribute("name")?a.showGroupLinks(d.id,d):a.hideGroupLinks(d);break;case"del_link":e=c.parentNode.parentNode,h=i(e.id),a.delLink(h.storage_name,h.id,e);break;case"edit_link":e=c.parentNode.parentNode,h=i(e.id),a.editLink(h.storage_name,h.id,e)}},!1)},go:function(){this.showGroups(),this.setHandlers()}},q={groupHtmlElement:function(a,c){var d,e=utils.formatDate(new Date(parseInt(a.slice("tg_".length),10)),b.date_format),f=function(){return{numbers_of_windows:i.groupLinksByWindowId(a).windowId_arr.length,numbers_of_tabs:h.getGroups()[a].tabs.length}}();return""===c.name&&(d=e),a===localStorage.session_id&&(d=k.current_session+" ("+e+")"),'<div id="'+a+'" class="group"><span class="spoiler" name="closed"> &#9658;</span><span class="open_group">'+d+'</span><span class="open_in_new_window" title="'+k.title_group_in_new_window+'">&#10064;</span> <span class="numbers_of_windows">'+k.windows_numbers+" "+f.numbers_of_windows+'</span><span class="numbers_of_tabs">'+k.tabs_numbers+" "+f.numbers_of_tabs+'</span><span class="group_action"><span class="del_group" title="'+k.title_del_group+'">&#10006;</span></span></div>'},linkHtmlElement:function(a,b){var c=b.title,d="",e=44,f=b.pinned===!0?'<img class="pinned_icon" src="img/pin-26.png">':"",g="chrome"===localStorage.browser?"chrome://favicon/"+b.url:"opera://favicon/"+b.url;return b.title.length>e&&(c=b.title.slice(0,e)+"...",d='title="'+b.title+'"'),'<div class="link"><span class="link_action"><a href="'+b.url+'" target="_blank" '+d+'><span class="favi" title="'+b.url+'"><img src="'+g+'"></span>'+f+c+"</a></span></div>"},openGroup:function(a,b){var c,d=[];1===b?(c=i.groupLinksByWindowId(a),c.windowId_arr.forEach(function(a,b){d=[],c.grouped_by_windowId[b].forEach(function(a){d.push(a)}),m(d)})):n(h.getGroups()[a].tabs)},openWindow:function(a,b,c){var d=h.getGroups()[a].tabs,e=[];1===c?(d.forEach(function(a){a.windowId===parseInt(b,10)&&e.push(a)}),m(e)):o(d,b)},showGroups:function(){var a='<section id="sessions_error_msg"></section>',b=h.getGroups(),c=this,d=document.getElementById("sessions"),e=Object.keys(b).sort(function(a,b){return parseInt(b.slice("tg_".length),10)-parseInt(a.slice("tg_".length),10)});e.forEach(function(d){a+=c.groupHtmlElement(d,b[d])}),d.innerHTML=a},delGroup:function(a,b){var c=this;h.del(a,function(a){0===a.err?b.remove():c.showErrorMsg(a.msg)})},showGroupLinks:function(a,b){var c=document.createElement("div"),d=b.getElementsByClassName("spoiler")[0],e="",f=this,g=i.groupLinksByWindowId(a);g.grouped_by_windowId.forEach(function(b,c){var d='<div class="win"><div class="win_title" id="'+a+"_"+g.windowId_arr[c]+'">&#9642; '+k.window_text+" "+(c+1)+"</div>";b.forEach(function(b){d+=f.linkHtmlElement(a,b)}),d+="</div>",e+=d}),c.classList.add("links"),c.innerHTML=e,b.insertBefore(c,null),d.setAttribute("name","opened"),d.innerHTML=" &#9660;"},hideGroupLinks:function(a){var b=a.getElementsByClassName("spoiler")[0];b.setAttribute("name","closed"),b.innerHTML=" &#9658;",a.getElementsByClassName("links")[0].remove()},setHandlers:function(){var a=this;document.getElementById("sessions").addEventListener("click",function(b){var d,e,f,c=b.target;switch(b.stopPropagation(),c.className){case"del_group":d=c.parentNode.parentNode,a.delGroup(d.id,d);break;case"spoiler":d=c.parentNode,"closed"===c.getAttribute("name")?a.showGroupLinks(d.id,d):a.hideGroupLinks(d);break;case"open_group":e=b.button,0===e&&b.ctrlKey===!0?a.openGroup(c.parentNode.id,1):a.openGroup(c.parentNode.id,b.button);break;case"open_in_new_window":a.openGroup(c.parentNode.id,1);break;case"win_title":e=b.button,f=function(){var a=c.id.lastIndexOf("_");return{storage_name:c.id.slice(0,a),window_id:c.id.slice(a+1)}}(),0===e&&b.ctrlKey===!0?a.openWindow(f.storage_name,f.window_id,1):a.openWindow(f.storage_name,f.window_id,0)}},!1)},go:function(){this.showGroups(),this.setHandlers()}};chrome.runtime.lastError?(document.getElementById("error_msg").style.display="block",document.getElementById("error_msg").innerText=k.quota_default_item):(r=new Tabs("#main_tabs"),r.toggle(b.active_tab),r.onToggle(function(a){chrome.storage.sync.set({active_tab:a})}),b.session_watcher?q.go():(r.toggle("#saved"),document.querySelector(".tabs_nav").querySelector('[href="#sessions"]').parentNode.style.display="none"),p.go())})});